<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>D3 HW04 Histogram</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
</head>

<body>
    <input type="button" value="new" onclick="update()">
    <script>
        d3.json("invoice-taipei.json", function (dataSet) {
            var count = 0;
            for (var i = 0; i < dataSet.length; i++) {
                if (dataSet[i].date === "2016/8/1" && dataSet[i].amount > 1000000000 && dataSet[i].cid === "A") {
                    d3.select("svg").append("rect").attr({
                        x: 160,
                        y: 15 + 12 * count,
                        width: dataSet[i].amount / 100000000,
                        height: 10,
                        fill: "red"
                    });
                    d3.select("svg").append("text").attr({
                        x: 0,
                        y: 22 + 12 * count,
                        "font-size": 10
                    }).text(count + 1 + "." + dataSet[i].industry);

                    d3.select("svg").append("text").attr({
                        x: 165 + dataSet[i].amount / 100000000,
                        y: 24 + 12 * count,
                        "font-size": 8
                    }).text(Math.floor(dataSet[i].amount / 100000000) + "億");
                    count = count + 1;
                    //d3.select("body").append("div").text(i + ":" + dataSet[i].industry + ",$" + dataSet[i].amount);


                }
            }
        });


        var h = 400;
        var w = 800;
        var p = 50;
        var arr = [85, 60, 99, 49, 77, 82];
        svg(h, w, p);

        for (i = 0; i < 6; i++) {
            if (arr[i] < 60) {
                d3.select("body").append("div").text(i + ":" + arr[i]).style({
                    color: "red"
                });
            } else if (arr[i] < 80) {
                d3.select("body").append("div").text(i + ":" + arr[i]).style({
                    color: "blue"
                });
            } else {
                d3.select("body").append("div").text(i + ":" + arr[i])
            };
        }

        bind(arr);
        render(h, w, p);

        bind2(arr);
        render2(h, w, p);


        function svg(h, w, p) {
            d3.select("body").append("svg").attr({
                width: w,
                height: h
            });
        }

        function update() {

            var num = random(20, 80);
            arr.push(num);
            bind(arr);
            render(h, w, p);

            bind2(arr);
            render2(h, w, p);

            //click new will keep the histogram chart
            d3.json("invoice-taipei.json", function (dataSet) {
                var count = 0;
                for (var i = 0; i < dataSet.length; i++) {
                    if (dataSet[i].date === "2016/8/1" && dataSet[i].amount > 1000000000 && dataSet[i].cid === "A") {
                        d3.select("svg").append("rect").attr({
                            x: 160,
                            y: 15 + 12 * count,
                            width: dataSet[i].amount / 100000000,
                            height: 10,
                            fill: "red"
                        });
                        d3.select("svg").append("text").attr({
                            x: 0,
                            y: 22 + 12 * count,
                            "font-size": 10
                        }).text(count + 1 + "." + dataSet[i].industry);

                        d3.select("svg").append("text").attr({
                            x: 165 + dataSet[i].amount / 100000000,
                            y: 24 + 12 * count,
                            "font-size": 8
                        }).text(Math.floor(dataSet[i].amount / 100000000) + "億");
                        count = count + 1;
                        //d3.select("body").append("div").text(i + ":" + dataSet[i].industry + ",$" + dataSet[i].amount);


                    }
                }
            });
        }

        function random(n, m) {
            return Math.floor(Math.random() * n + (m - n));
        }

        function bind(data) {

            var selection = d3.select("svg")
                .selectAll("rect")
                .data(data);

            selection.enter().append("rect");
            selection.exit().remove();

        }

        function render(h, w, p) {
            d3.selectAll("rect").attr({
                x: function (d, i) {
                    return p + 45 * i;
                },
                y: function (d, i) {
                    return h - p - d;
                },
                width: 40,
                height: function (d) {
                    return d;
                },
                fill: function (d) {
                    if (d < 70) return "red";
                    else return "lightgreen";
                }

            });

        }

        function bind2(data) {

            var selection = d3.select("svg")
                .selectAll("text")
                .data(data);

            selection.enter().append("text");
            selection.exit().remove();

        }

        function render2(h, w, p) {
            d3.selectAll("text").attr({
                x: function (d, i) {
                    return p + 45 * i + 10;
                },
                y: h - p + 20,

                fill: "black"
            }).text(function (d) {
                return d;
            });

        }
    </script>



</body>

</html>